{{/*
Shortcode: latest-with-image.html
Params:
  - pages: (optional) slice of pages; defaults to .Site.RegularPages
  - count: (optional) number of posts; defaults to 7
  - width: (optional) media width in px; defaults to 300
  - height: (optional) media height in px; defaults to 300
*/}}
{{ $ctx := . }}
{{ $pages := default .Site.RegularPages ($ctx.Get "pages") }}
{{ $count := default 7 ($ctx.Get "count") | int }}
{{ $width := default 300 ($ctx.Get "width") | int }}
{{ $height := default 300 ($ctx.Get "height") | int }}
{{ $posts := first $count (sort $pages "Date" "desc") }}

<div class="latest-with-image-list">
  {{- range $posts }}
    {{ $p := . }}
    {{/* Find first media tag */}}
    {{ $rawTag := "" }}
    {{ $src := "" }}
    {{ $match := findRE `(?s)<(?:img|iframe)[^>]*src=\"([^\"]+)\"[^>]*>` $p.Content }}
    {{ if gt (len $match) 0 }}
      {{ $rawTag = index $match 0 }}
      {{ $src = replaceRE `(?s).*src=\"([^\"]+)\".*` `$1` $rawTag }}
    {{ else if $p.Params.featured_image }}
      {{ $rawTag = printf `<img src=\"%s\">` $p.Params.featured_image }}
      {{ $src = $p.Params.featured_image }}
    {{ end }}

    <article class="latest-item">
      <div class="media-column">
        <div class="media-container" style="width:{{ $width }}px;height:{{ $height }}px;">
          {{ if in $src "youtube.com" }}
            {{ $vid := replaceRE `.*(?:embed/|v=)([^?&/]+).*` `$1` $src }}
            <a href="{{ $p.RelPermalink }}">
              <img src="https://img.youtube.com/vi/{{ $vid }}/hqdefault.jpg" alt="{{ $p.Title }}">
            </a>
          {{ else if in $rawTag "<iframe" }}
            <a href="{{ $p.RelPermalink }}">
              <div class="media-placeholder"></div>
            </a>
          {{ else if in $rawTag "<img" }}
            <a href="{{ $p.RelPermalink }}">
              <img src="{{ $src }}" alt="{{ $p.Title }}">
            </a>
          {{ else }}
            <a href="{{ $p.RelPermalink }}">
              <div class="media-placeholder"></div>
            </a>
          {{ end }}
        </div>
      </div>
      <div class="text-column">
        <h2 class="post-title"><a href="{{ $p.RelPermalink }}">{{ $p.Title }}</a></h2>
        <div class="post-summary">{{ $p.Summary | safeHTML }}</div>
        <p class="read-more"><a href="{{ $p.RelPermalink }}">Read more â†’</a></p>
      </div>
    </article>
  {{- end }}
</div>
